<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FareCalculatorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">parking-system</a> &gt; <a href="index.source.html" class="el_package">com.parkit.parkingsystem.service</a> &gt; <span class="el_source">FareCalculatorService.java</span></div><h1>FareCalculatorService.java</h1><pre class="source lang-java linenums">package com.parkit.parkingsystem.service;

import com.parkit.parkingsystem.constants.Fare;
import com.parkit.parkingsystem.constants.ParkingType;
import com.parkit.parkingsystem.dao.TicketDAO;
import com.parkit.parkingsystem.model.Ticket;
import com.parkit.parkingsystem.util.DateConvertUtil;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.List;

public class FareCalculatorService {

    private final TicketDAO ticketDAO;
    public FareCalculatorService(TicketDAO ticketDAO)
<span class="fc" id="L17">    {</span>
<span class="fc" id="L18">        this.ticketDAO = ticketDAO;</span>
<span class="fc" id="L19">    }</span>
    /**
     * Calculate Fare for given ticket
     * @param ticket ticket to use to calculate fare
     */
    public void calculateFare(Ticket ticket) {
<span class="fc bfc" id="L25" title="All 4 branches covered.">        if ((ticket.getOutTime() == null) || (ticket.getOutTime().before(ticket.getInTime()))) {</span>
<span class="fc" id="L26">            throw new IllegalArgumentException(&quot;Out time provided is null or incorrect&quot;);</span>
        }

<span class="fc" id="L29">        LocalDateTime inLocalDatTime = DateConvertUtil.convertToLocalDateTimeViaInstant(ticket.getInTime());</span>
<span class="fc" id="L30">        LocalDateTime outLocalDatTime = DateConvertUtil.convertToLocalDateTimeViaInstant(ticket.getOutTime());</span>
<span class="fc" id="L31">        Duration durationBetweenInAndOut = Duration.between(inLocalDatTime, outLocalDatTime);</span>

        //calculate and affect ticket price
<span class="fc" id="L34">        ticket.setPrice(getTicketPrice(ticket.getParkingSpot().getParkingType(), durationBetweenInAndOut ));</span>

        //test if ticket is eligible to discount
<span class="fc bfc" id="L37" title="All 2 branches covered.">        if (isEligibleToDiscount(ticket))</span>
        {
<span class="fc" id="L39">            ticket.setPrice(getDiscountPrice(ticket.getPrice()));</span>
        }

<span class="fc" id="L42">    }</span>



    /**
     * Get price ticket relative to ParkingType and number of hours of parking
     * @param parkingType type of parking
     * @param parkingDuration parking duration representation
     */
    private double getTicketPrice(ParkingType parkingType, Duration parkingDuration)
    {
<span class="fc bfc" id="L53" title="All 2 branches covered.">        if (!isFreeParking(parkingDuration)) {</span>
<span class="fc" id="L54">            double nbHoursParkingDuration = DateConvertUtil.getDecimalHoursFromDuration(parkingDuration);</span>
<span class="pc bpc" id="L55" title="1 of 3 branches missed.">            switch (parkingType) {</span>
                case CAR:
<span class="fc" id="L57">                    return nbHoursParkingDuration * Fare.CAR_RATE_PER_HOUR;</span>

                case BIKE:
<span class="fc" id="L60">                    return nbHoursParkingDuration * Fare.BIKE_RATE_PER_HOUR;</span>

                default:
<span class="nc" id="L63">                    throw new IllegalArgumentException(&quot;Unknown Parking Type&quot;);</span>
            }
        }
        else
        {
<span class="fc" id="L68">            return 0.0;</span>
        }
    }

    /**
     * Check if parking is free relative to parking duration in decimal hours
     * @param duration parking duration object
     * @return true if parking can be free, false otherwise
     */
    private boolean isFreeParking(Duration duration)
    {
<span class="fc bfc" id="L79" title="All 2 branches covered.">        return duration.toMinutes()&lt;Fare.NB_MINUTES_BEFORE_PAID_PARKING;</span>
    }

    /**
     * Search and Apply discount
     * @param ticket ticket applying for discount
     * @return true if ticket is eligible to discount
     */
    public boolean isEligibleToDiscount(Ticket ticket)
    {
<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (ticket.getVehicleRegNumber()!=null) {</span>
<span class="fc" id="L90">            List&lt;Ticket&gt; previousPaidTickets = ticketDAO.getPaidTickets(ticket.getVehicleRegNumber());</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">            return !previousPaidTickets.isEmpty();</span>
        }
        else
        {
<span class="fc" id="L95">            return false;</span>
        }
    }

    /**
     * Calculate Discount Price
     * @param price price on which apply discount
     * @return
     */
    private double getDiscountPrice(double price) {
<span class="fc" id="L105">        return price * (100.0 - Fare.DISCOUNT_PERCENTAGE_FOR_REGULAR_USER) / 100.0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>